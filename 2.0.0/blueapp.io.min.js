require=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){(function(){var match,pl=/\+/g,search=/([^&=]+)=?([^&]*)/g,decode=function(s){return decodeURIComponent(s.replace(pl," "))},query=window.location.search.substring(1);var urlParams={};var scanIndicTimeOut;var scanned_perips={};while(match=search.exec(query))urlParams[decode(match[1])]=decode(match[2]);var gatewayToken=urlParams["token"];var deviceUUID=urlParams["uuid"];var proxyUrl=urlParams["proxyUrl"];var cordovaApp=urlParams["app"]=="true";var updateUI=function(peripheral){clearTimeout(scanIndicTimeOut);scanned_perips[peripheral.uuid]=peripheral;var mytable='<table cellpadding="0" cellspacing="0"><tbody><tr>';for(var uuid in scanned_perips){mytable+="</tr><tr onclick='onPeripheralSelect("+'"'+uuid+'"'+")'>";mytable+="<td>"+scanned_perips[uuid].name+"</td>"}document.getElementById("peripheral").innerHTML=mytable};window.wbDialogCancel=function(msg,timeout,onReject){var modal=document.getElementById("picker");if(modal){modal.style.display="none"}if(timeout){clearTimeout(timeout)}if(onReject){onReject(msg)}};var showScanPickerDialog=function(onSelect,onReject){var peripheralDiv=document.createElement("div");peripheralDiv.setAttribute("id","peripheral");var scanDialogDiv=document.createElement("div");scanDialogDiv.setAttribute("id","scanDialog");var pickerDiv=document.createElement("div");pickerDiv.setAttribute("id","picker");pickerDiv.appendChild(peripheralDiv);document.body.appendChild(scanDialogDiv);document.body.appendChild(pickerDiv);scanned_perips={};window.onPeripheralSelect=function(uuid){var modal=document.getElementById("picker");modal.style.display="none";onSelect(scanned_perips[uuid])};scanIndicTimeOut=setTimeout(function(){console.log("Requested device not found :(");window.wbDialogCancel("Requested device not found!",scanIndicTimeOut,onReject)},6e4);document.getElementById("scanDialog").innerHTML="<style>"+".modal {"+"    display: block;"+"    position: fixed;"+"    z-index: 1;"+"    padding-top: 100px;"+"    left: 0;"+"    width: 100%;"+"    height: 100%;"+"    overflow: auto;"+"    background-color: rgb(0, 0, 0);"+"    background-color: rgba(0, 0, 0, 0.4);"+"}"+""+".modal-content {"+"    background-color: #fefefe;"+"    margin: auto;"+"    padding: 20px;"+"    border: 1px solid #888;"+"    width: 80%;"+"}"+""+".spacing-table td {"+"    border-width: 3px 0;"+"    padding: 10px 10px;"+""+"}"+""+".div-border {"+"    border-collapse: collapse;"+"    border: 1px solid #b5aeae;;"+"}"+""+"tr:hover {"+"   background: #dddddd !important;"+"}"+""+"</style>"+'<div id= "picker" style= "z-index: 100;" class= "modal">'+'    <div class= "modal-content">'+'       <div style="font-size: 15px; padding-bottom: 10px; color: black"> App wants to pair with : </div>'+'        <div class= "spacing-table div-border" style="color: black" id=\'peripheral\'>'+"        </div>"+'        <div style="text-align: right; margin-top: 10px; font-size: 14px;">'+'        <button type= "button" onclick= "window.wbDialogCancel(\'Scan stopped!\')" style="padding: 4px;">Cancel</button>'+"    </div>"+"    </div>"+"</div>"};var dataResponse=function(data){if(data.peripheral){updateUI(data.peripheral)}else{showScanPickerDialog(data.select,data.reject)}};var getBlueAppBluetoothObject=function(){if(typeof window.bawb==="object"){return window.bawb}var stream;if(cordovaApp){var returnDataCallback=dataResponse;stream={};var onerror=function(error){if(stream.onerror){stream.onerror(error)}};var onmessage=function(data){if(data&&stream.onmessage){var message={data:data};stream.onmessage(message)}};stream.close=function(){blueappio.request("close",undefined,onmessage,onerror)};stream.send=function(data){blueappio.request("message",data,onmessage,onerror)};blueappio.request("init",{},onmessage,onerror)}window.bawb=require("blueapp-wb").init({url:proxyUrl,token:gatewayToken,scanFilters:{uuids:[deviceUUID]},stream:stream,returnData:returnDataCallback,errorCallback:window.wbDialogCancel}).navigator.bluetooth;return window.bawb};function loadBluetooth(){if(Object.defineProperty){Object.defineProperty(navigator,"bluetooth",{get:getBlueAppBluetoothObject})}else if(Object.prototype.__defineGetter__){navigator.__defineGetter__("bluetooth",getBlueAppBluetoothObject)}var x=navigator.bluetooth}if(typeof navigator==="object"){if(cordovaApp){document.addEventListener("deviceready",loadBluetooth,false)}else if(!gatewayToken){}else{loadBluetooth()}}else{console.log("Browser does not support the navigator object")}})()},{"blueapp-wb":3}],2:[function(require,module,exports){var EventEmitter=require("events");var util=require("util");module.exports.makeEmitter=function(contructor){util.inherits(contructor,EventEmitter)};module.exports.instantiateEmitter=function(object){EventEmitter.call(object)}},{events:12,util:32}],3:[function(require,module,exports){"use strict";var GATTIP=require("gatt-ip").GATTIP;var util=require("./util.js");var thirdparty=require("./thirdparty");var BluetoothDevice=require("./wb-device").BluetoothDevice;var filtersLib=require("./wb-filters");var config;module.exports.navigator=undefined;function BlueAppWebBluetooth(g){this.gateway=g}BlueAppWebBluetooth.prototype.requestDevice=function(requestDeviceOptions){var optionalServices;var matchedFilter;var filters=requestDeviceOptions.filters;var acceptAllDevices=requestDeviceOptions.acceptAllDevices;optionalServices=requestDeviceOptions.optionalServices;var g=this.gateway;var filtering;return util.errorLoggingPromise(function(fulfill,reject){if(g.getGateway()){fulfill(g.getGateway())}else{g.once("ready",function(gateway){fulfill(gateway)})}}).then(function(){return util.errorLoggingPromise(function(fulfill,reject){var timeout=setTimeout(function(){if(config.errorCallback){config.errorCallback({error:"Timed out"})}else{reject("Timed out")}},3e4);var validFiltersObj=filtersLib.checkFilters(filters,acceptAllDevices,optionalServices);if(validFiltersObj.error){reject(validFiltersObj.message);return reject}else{filtering=validFiltersObj.isFiltering}var gw=g.getGateway();function onScan(peripheral){clearTimeout(timeout);var filteredPeripheral;if(filtering){var filteredDevice=filtersLib.filterScan(peripheral,filters,optionalServices);filteredPeripheral=filteredDevice.peripheral;matchedFilter=filteredDevice.filter}else{matchedFilter=undefined}if(config.returnData){if(filtering){if(filteredPeripheral){config.returnData({peripheral:filteredPeripheral})}}else{config.returnData({peripheral:peripheral})}}else{if(filtering){if(filteredPeripheral){gw.removeListener("scan",onScan);onSelect(filteredPeripheral)}}else{onSelect(peripheral)}}}function onSelect(peripheral){gw.stopScan(function(){gw.removeListener("scan",onScan);console.log("Scan stopped");console.log("FOUND1",peripheral.name);var dev=new BluetoothDevice(g,peripheral,filtersLib,optionalServices,matchedFilter);matchedFilter=undefined;dev.gatt=dev;fulfill(dev)})}function onReject(msg){gw.stopScan(function(){console.log("Scan stopped")});reject(msg)}g.on("state",function(bluetoothPower){if(!bluetoothPower){reject("Bluetooth is off")}});gw.scan(function(){if(config.returnData){config.returnData({select:onSelect,reject:onReject})}gw.on("scan",onScan)})})})};module.exports.init=function(configObj){if(!configObj){config={}}else{config=configObj}var g=new GATTIP;g.BluetoothUUID=thirdparty.BluetoothUUID;var navigator={};navigator.bluetooth=new BlueAppWebBluetooth(g);if(config.token){navigator.bluetooth.referringDevice={dummy:"this is a dummy device",id:config.deviceUUID}}navigator.bluetooth.gattip=g;g.open(config);g.on("error",function(error){console.error("Service Error:",error.message);if(error.stack){console.error("Error Stack:",error.stack)}});return{navigator:navigator}}},{"./thirdparty":4,"./util.js":5,"./wb-device":8,"./wb-filters":9,"gatt-ip":"gatt-ip"}],4:[function(require,module,exports){var uuidRegex=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function canonicalUUID(uuidAlias){uuidAlias>>>=0;var strAlias="0000000"+uuidAlias.toString(16);strAlias=strAlias.substr(-8);return strAlias+"-0000-1000-8000-00805f9b34fb"}function ResolveUUIDName(tableName){var table=module.exports.BluetoothUUID[tableName];return function(name){if(typeof name==="string"){name=name.toLowerCase()}if(typeof name==="number"){return canonicalUUID(name)}else if(uuidRegex.test(name)){return name}else if(table.hasOwnProperty(name)){return table[name]}else{throw new NamedError("SyntaxError",'"'+name+'" is not a known '+tableName+" name.")}}}module.exports.BluetoothUUID={};module.exports.BluetoothUUID.canonicalUUID=canonicalUUID;module.exports.BluetoothUUID.service={alert_notification:canonicalUUID(6161),automation_io:canonicalUUID(6165),battery_service:canonicalUUID(6159),blood_pressure:canonicalUUID(6160),body_composition:canonicalUUID(6171),bond_management:canonicalUUID(6174),continuous_glucose_monitoring:canonicalUUID(6175),current_time:canonicalUUID(6149),cycling_power:canonicalUUID(6168),cycling_speed_and_cadence:canonicalUUID(6166),device_information:canonicalUUID(6154),environmental_sensing:canonicalUUID(6170),generic_access:canonicalUUID(6144),generic_attribute:canonicalUUID(6145),glucose:canonicalUUID(6152),health_thermometer:canonicalUUID(6153),heart_rate:canonicalUUID(6157),human_interface_device:canonicalUUID(6162),immediate_alert:canonicalUUID(6146),indoor_positioning:canonicalUUID(6177),internet_protocol_support:canonicalUUID(6176),link_loss:canonicalUUID(6147),location_and_navigation:canonicalUUID(6169),next_dst_change:canonicalUUID(6151),phone_alert_status:canonicalUUID(6158),pulse_oximeter:canonicalUUID(6178),reference_time_update:canonicalUUID(6150),running_speed_and_cadence:canonicalUUID(6164),scan_parameters:canonicalUUID(6163),tx_power:canonicalUUID(6148),user_data:canonicalUUID(6172),weight_scale:canonicalUUID(6173)};module.exports.BluetoothUUID.characteristic={aerobic_heart_rate_lower_limit:canonicalUUID(10878),aerobic_heart_rate_upper_limit:canonicalUUID(10884),aerobic_threshold:canonicalUUID(10879),age:canonicalUUID(10880),aggregate:canonicalUUID(10842),alert_category_id:canonicalUUID(10819),alert_category_id_bit_mask:canonicalUUID(10818),alert_level:canonicalUUID(10758),alert_notification_control_point:canonicalUUID(10820),alert_status:canonicalUUID(10815),altitude:canonicalUUID(10931),anaerobic_heart_rate_lower_limit:canonicalUUID(10881),anaerobic_heart_rate_upper_limit:canonicalUUID(10882),anaerobic_threshold:canonicalUUID(10883),analog:canonicalUUID(10840),apparent_wind_direction:canonicalUUID(10867),apparent_wind_speed:canonicalUUID(10866),"gap.appearance":canonicalUUID(10753),barometric_pressure_trend:canonicalUUID(10915),battery_level:canonicalUUID(10777),blood_pressure_feature:canonicalUUID(10825),blood_pressure_measurement:canonicalUUID(10805),body_composition_feature:canonicalUUID(10907),body_composition_measurement:canonicalUUID(10908),body_sensor_location:canonicalUUID(10808),bond_management_control_point:canonicalUUID(10916),bond_management_feature:canonicalUUID(10917),boot_keyboard_input_report:canonicalUUID(10786),boot_keyboard_output_report:canonicalUUID(10802),boot_mouse_input_report:canonicalUUID(10803),"gap.central_address_resolution_support":canonicalUUID(10918),cgm_feature:canonicalUUID(10920),cgm_measurement:canonicalUUID(10919),cgm_session_run_time:canonicalUUID(10923),cgm_session_start_time:canonicalUUID(10922),cgm_specific_ops_control_point:canonicalUUID(10924),cgm_status:canonicalUUID(10921),csc_feature:canonicalUUID(10844),csc_measurement:canonicalUUID(10843),current_time:canonicalUUID(10795),cycling_power_control_point:canonicalUUID(10854),cycling_power_feature:canonicalUUID(10853),cycling_power_measurement:canonicalUUID(10851),cycling_power_vector:canonicalUUID(10852),database_change_increment:canonicalUUID(10905),date_of_birth:canonicalUUID(10885),date_of_threshold_assessment:canonicalUUID(10886),date_time:canonicalUUID(10760),day_date_time:canonicalUUID(10762),day_of_week:canonicalUUID(10761),descriptor_value_changed:canonicalUUID(10877),"gap.device_name":canonicalUUID(10752),dew_point:canonicalUUID(10875),digital:canonicalUUID(10838),dst_offset:canonicalUUID(10765),elevation:canonicalUUID(10860),email_address:canonicalUUID(10887),exact_time_256:canonicalUUID(10764),fat_burn_heart_rate_lower_limit:canonicalUUID(10888),fat_burn_heart_rate_upper_limit:canonicalUUID(10889),firmware_revision_string:canonicalUUID(10790),first_name:canonicalUUID(10890),five_zone_heart_rate_limits:canonicalUUID(10891),floor_number:canonicalUUID(10930),gender:canonicalUUID(10892),glucose_feature:canonicalUUID(10833),glucose_measurement:canonicalUUID(10776),glucose_measurement_context:canonicalUUID(10804),gust_factor:canonicalUUID(10868),hardware_revision_string:canonicalUUID(10791),heart_rate_control_point:canonicalUUID(10809),heart_rate_max:canonicalUUID(10893),heart_rate_measurement:canonicalUUID(10807),heat_index:canonicalUUID(10874),height:canonicalUUID(10894),hid_control_point:canonicalUUID(10828),hid_information:canonicalUUID(10826),hip_circumference:canonicalUUID(10895),humidity:canonicalUUID(10863),"ieee_11073-20601_regulatory_certification_data_list":canonicalUUID(10794),indoor_positioning_configuration:canonicalUUID(10925),intermediate_blood_pressure:canonicalUUID(10806),intermediate_temperature:canonicalUUID(10782),irradiance:canonicalUUID(10871),language:canonicalUUID(10914),last_name:canonicalUUID(10896),latitude:canonicalUUID(10926),ln_control_point:canonicalUUID(10859),ln_feature:canonicalUUID(10858),"local_east_coordinate.xml":canonicalUUID(10929),local_north_coordinate:canonicalUUID(10928),local_time_information:canonicalUUID(10767),location_and_speed:canonicalUUID(10855),location_name:canonicalUUID(10933),longitude:canonicalUUID(10927),magnetic_declination:canonicalUUID(10796),magnetic_flux_density_2D:canonicalUUID(10912),magnetic_flux_density_3D:canonicalUUID(10913),manufacturer_name_string:canonicalUUID(10793),maximum_recommended_heart_rate:canonicalUUID(10897),measurement_interval:canonicalUUID(10785),model_number_string:canonicalUUID(10788),navigation:canonicalUUID(10856),new_alert:canonicalUUID(10822),"gap.peripheral_preferred_connection_parameters":canonicalUUID(10756),"gap.peripheral_privacy_flag":canonicalUUID(10754),plx_continuous_measurement:canonicalUUID(10847),plx_features:canonicalUUID(10848),plx_spot_check_measurement:canonicalUUID(10846),pnp_id:canonicalUUID(10832),pollen_concentration:canonicalUUID(10869),position_quality:canonicalUUID(10857),pressure:canonicalUUID(10861),protocol_mode:canonicalUUID(10830),rainfall:canonicalUUID(10872),"gap.reconnection_address":canonicalUUID(10755),record_access_control_point:canonicalUUID(10834),reference_time_information:canonicalUUID(10772),report:canonicalUUID(10829),report_map:canonicalUUID(10827),resting_heart_rate:canonicalUUID(10898),ringer_control_point:canonicalUUID(10816),ringer_setting:canonicalUUID(10817),rsc_feature:canonicalUUID(10836),rsc_measurement:canonicalUUID(10835),sc_control_point:canonicalUUID(10837),scan_interval_window:canonicalUUID(10831),scan_refresh:canonicalUUID(10801),sensor_location:canonicalUUID(10845),serial_number_string:canonicalUUID(10789),"gatt.service_changed":canonicalUUID(10757),software_revision_string:canonicalUUID(10792),sport_type_for_aerobic_and_anaerobic_thresholds:canonicalUUID(10899),supported_new_alert_category:canonicalUUID(10823),supported_unread_alert_category:canonicalUUID(10824),system_id:canonicalUUID(10787),temperature:canonicalUUID(10862),temperature_measurement:canonicalUUID(10780),temperature_type:canonicalUUID(10781),three_zone_heart_rate_limits:canonicalUUID(10900),time_accuracy:canonicalUUID(10770),time_source:canonicalUUID(10771),time_update_control_point:canonicalUUID(10774),time_update_state:canonicalUUID(10775),time_with_dst:canonicalUUID(10769),time_zone:canonicalUUID(10766),true_wind_direction:canonicalUUID(10865),true_wind_speed:canonicalUUID(10864),two_zone_heart_rate_limit:canonicalUUID(10901),tx_power_level:canonicalUUID(10759),uncertainty:canonicalUUID(10932),unread_alert_status:canonicalUUID(10821),user_control_point:canonicalUUID(10911),user_index:canonicalUUID(10906),uv_index:canonicalUUID(10870),vo2_max:canonicalUUID(10902),waist_circumference:canonicalUUID(10903),weight:canonicalUUID(10904),weight_measurement:canonicalUUID(10909),weight_scale_feature:canonicalUUID(10910),wind_chill:canonicalUUID(10873)};module.exports.BluetoothUUID.descriptor={"gatt.characteristic_extended_properties":canonicalUUID(10496),"gatt.characteristic_user_description":canonicalUUID(10497),"gatt.client_characteristic_configuration":canonicalUUID(10498),"gatt.server_characteristic_configuration":canonicalUUID(10499),"gatt.characteristic_presentation_format":canonicalUUID(10500),"gatt.characteristic_aggregate_format":canonicalUUID(10501),valid_range:canonicalUUID(10502),external_report_reference:canonicalUUID(10503),report_reference:canonicalUUID(10504),value_trigger_setting:canonicalUUID(10506),es_configuration:canonicalUUID(10507),es_measurement:canonicalUUID(10508),es_trigger_setting:canonicalUUID(10509)};module.exports.BluetoothUUID.getService=ResolveUUIDName("service");module.exports.BluetoothUUID.getCharacteristic=ResolveUUIDName("characteristic");module.exports.BluetoothUUID.getDescriptor=ResolveUUIDName("descriptor")},{}],5:[function(require,module,exports){var SHORT_UUID_SUFFFIX="-0000-1000-8000-00805F9B34FB";function toShortUUID(uuidStr){if(uuidStr.indexOf(SHORT_UUID_SUFFFIX)==8){if(uuidStr.indexOf("0000")==0){return uuidStr.substring(4,8)}else{return uuidStr.substring(0,8)}}else{return uuidStr}}module.exports.toVensiUUID=function(uuid){switch(typeof uuid){case"string":return toShortUUID(uuid.toUpperCase());break;case"number":return Number(uuid).toString(16).toUpperCase();break;default:console.warn("Unable to convert uuid "+uuid+" to hex string");return undefined}};module.exports.toWbUUID=function(uuid){if(uuid){uuid=uuid.toLowerCase()}return uuid};module.exports.hexAsArray=function(hex){var bytes=[];if(hex.length%2==1){hex="0"+hex}for(var i=0;i<hex.length-1;i+=2){bytes.push(parseInt(hex.substr(i,2),16))}return bytes};module.exports.arrayAsHex=function(array){var ret="";for(var i in array){byte=array[i];var value=(byte&255).toString(16);if(value.length==1){value="0"+value}ret+=value}return ret.toUpperCase()};module.exports.isHex=function(h){var validRegEx=/^[a-f0-9-x]+$/;return h.match(validRegEx)!=null};module.exports.isEmpty=function(obj){for(var prop in obj){if(obj.hasOwnProperty(prop)){return false}}return true};module.exports.uintArrayToString=function(uintArray){var stringFromUintArray=uintArray.toString();var arrayFromString=stringFromUintArray.split(",");for(var i=0;i<arrayFromString.length;i++){if(arrayFromString[i].length==1){arrayFromString[i]="0"+arrayFromString[i]}}return arrayFromString.join("")};module.exports.uncaughtError=function(error){console.error("Uncaught error:",error,error.stack)};module.exports.gattIpRequestPromise=function(func){return new Promise(function(fulfill,reject){try{func(fulfill,reject)}catch(error){module.exports.uncaughtError(error);throw error}})};module.exports.errorLoggingPromise=function(func){return new Promise(function(fulfill,reject){try{func(fulfill,reject)}catch(error){module.exports.uncaughtError(error);throw error}})}},{}],6:[function(require,module,exports){var util=require("./util.js");var ee=require("./event-emitter");var BluetoothGattDescriptor=require("./wb-descriptor").BluetoothGattDescriptor;var WB_PROPERTIES=["broadcast","read","writeWithoutResponse","write","notify","indicate","authenticatedSignedWrites","reliableWrite","writableAuxiliaries"];function BluetoothGattCharacteristic(webBluetoothService,gattipCharacteristic){ee.instantiateEmitter(this);var self=this;function onCharChanged(char,value){var arr=util.hexAsArray(value);self._value=new DataView(new Uint8Array(arr).buffer);self.emit("characteristicvaluechanged",{target:self})}this._gattIp=webBluetoothService._gattIp;this._service=webBluetoothService;this._gattipCharacteristic=gattipCharacteristic;gattipCharacteristic.wbCharacteristic=this;this._properties=new BluetoothCharacteristicProperties(gattipCharacteristic.allProperties());this._value=null;Object.defineProperty(this,"uuid",{get:function(){return util.toWbUUID(self._gattipCharacteristic.uuid)}});Object.defineProperty(this,"service",{get:function(){return self._service}});Object.defineProperty(this,"properties",{get:function(){return self._properties}});Object.defineProperty(this,"value",{get:function(){return self._value}});this.getAllDescriptors=function(descriptorUuids){return util.errorLoggingPromise(function(fulfill,reject){reject("Not implemented")})};this.getDescriptor=function(descriptorUuid){var self=this;return util.errorLoggingPromise(function(fulfill,reject){var vensiUuid=util.toVensiUUID(self._gattIp.BluetoothUUID.getDescriptor(descriptorUuid));if("undefined"==typeof vensiUuid){reject("Unable to find descriptor with requested UUID "+descriptorUuid)}else{var desc=self._gattipCharacteristic.findDescriptor(vensiUuid);if(desc){fulfill(new BluetoothGattDescriptor(self,desc))}else{reject("Descriptor "+descriptorUuid+" not found")}}})};this.readValue=function(){var self=this;return util.errorLoggingPromise(function(fulfill,reject){self._gattipCharacteristic.readValue({fulfill:function(desc,value){var arr=util.hexAsArray(value);fulfill(new DataView(new Uint8Array(arr).buffer))},reject:reject})})};this.writeValue=function(newValue){var self=this;return util.errorLoggingPromise(function(fulfill,reject){self._gattipCharacteristic.writeValue({fulfill:fulfill,reject:reject},util.arrayAsHex(Array.prototype.slice.call(newValue)))})};this.startNotifications=function(){var self=this;return util.errorLoggingPromise(function(fulfill,reject){if(self._isNotifying){reject("Already notifying");return}self._gattipCharacteristic.enableNotifications({fulfill:function(char,isNotifying){if(isNotifying){self._isNotifying=true;char.on("valueChange",onCharChanged);fulfill()}else{reject("Did not receive expected response from the gateway")}},reject:reject},true)})};this.stopNotifications=function(){var self=this;return util.errorLoggingPromise(function(fulfill,reject){if(!self._isNotifying){reject("Was not notifying");return}self._gattipCharacteristic.enableNotifications({fulfill:function(char,isNotifying){if(!isNotifying){self._isNotifying=false;char.removeListener("valueChange",onCharChanged);fulfill()}else{reject("Did not receive expected response from the gateway")}},reject:reject},false)})};this.addEventListener=function(eventName,cb){this.on(eventName,cb)};this.removeEventListener=function(eventName,cb){this.removeListener(eventName,cb)}}module.exports.BluetoothGattCharacteristic=BluetoothGattCharacteristic;ee.makeEmitter(BluetoothGattCharacteristic);function BluetoothCharacteristicProperties(gattIpProperties){function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}for(var i in WB_PROPERTIES){wbPropName=WB_PROPERTIES[i];var gattIpPropName=capitalizeFirstLetter(wbPropName);if("object"==typeof gattIpProperties[gattIpPropName]){this[wbPropName]=gattIpProperties[gattIpPropName].enabled==1}else if(wbPropName=="reliableWrite"||wbPropName=="writableAuxiliaries"){if(gattIpProperties["ExtendedProperties"]&&1===gattIpProperties["ExtendedProperties"].enabled){console.error("WB spec 5.4.1 section not fully implemented.");this[wbPropName]=false}else{this[wbPropName]=false}}}}},{"./event-emitter":2,"./util.js":5,"./wb-descriptor":7}],7:[function(require,module,exports){var util=require("./util");function BluetoothGattDescriptor(webBluetoothCharacteristic,gattIpDescriptor){this._gattIp=webBluetoothCharacteristic._gattIp;this._characteristic=webBluetoothCharacteristic;this._gattIpDescriptor=gattIpDescriptor;this._value=null}module.exports.BluetoothGattDescriptor=BluetoothGattDescriptor;BluetoothGattDescriptor.prototype={get uuid(){return util.toWbUUID(this._gattIpDescriptor.uuid)},get characteristic(){return this._characteristic},get value(){return this._value},readValue:function(){var self=this;return util.errorLoggingPromise(function(fulfill,reject){self._gattIpDescriptor.readValue({fulfill:function(desc,value){var arr=util.hexAsArray(value);fulfill(new DataView(new Uint8Array(arr).buffer))},reject:reject})})},writeValue:function(newValue){var self=this;return util.errorLoggingPromise(function(fulfill,reject){self._gattIpDescriptor.writeValue({fulfill:fulfill,reject:reject},util.arrayAsHex(Array.prototype.slice.call(newValue)))})}}},{"./util":5}],8:[function(require,module,exports){var util=require("./util.js");var ee=require("./event-emitter");var BluetoothGattService=require("./wb-service").BluetoothGattService;function BluetoothDevice(gattIp,gattIpPeripheral,filtersLib,optionalServices,filter){ee.instantiateEmitter(this);var self=this;this._gattIp=gattIp;this._gattIpPeripheral=gattIpPeripheral;function removeNotificationListeners(peripheral){var services=peripheral.getAllServices();for(var sUUID in services){var characteristics=services[sUUID].getAllCharacteristics();for(var cUUID in characteristics){if(characteristics[cUUID].wbCharacteristic){console.log("removing the listeners for characteristic :"+cUUID);characteristics[cUUID].wbCharacteristic.removeAllListeners()}}}}this.addEventListener=function(eventName,cb){this.on(eventName,cb)};this.removeEventListener=function(eventName,cb){this.removeListener(eventName,cb)};function onDisconnected(peripheral){removeNotificationListeners(peripheral);self.emit("gattserverdisconnected",{target:self})}this._gattIpPeripheral.once("disconnected",onDisconnected);Object.defineProperty(this,"name",{get:function(){return self._gattIpPeripheral.name}});Object.defineProperty(this,"uuid",{get:function(){return self._gattIpPeripheral.uuid}});Object.defineProperty(this,"deviceClass",{get:function(){return undefined}});Object.defineProperty(this,"vendorIdSource",{get:function(){return undefined}});Object.defineProperty(this,"vendorId",{get:function(){return undefined}});Object.defineProperty(this,"productId",{get:function(){return undefined}});Object.defineProperty(this,"productVersion",{get:function(){return undefined}});Object.defineProperty(this,"paired",{get:function(){return false}});Object.defineProperty(this,"connected",{get:function(){return self._gattIpPeripheral.isConnected}});Object.defineProperty(this,"uuids",{get:function(){return self._gattIpPeripheral.serviceUUIDs}});this.connect=function(){var self=this;return new Promise(function(fulfill,reject){self._gattIpPeripheral.connect({fulfill:function(peripheral){console.error("Hack alert:  _gattIpPeripheral reset");self._gattIpPeripheral=peripheral;fulfill(self)},reject:reject})})};this.disconnect=function(){var self=this;return util.errorLoggingPromise(function(fulfill,reject){self._gattIpPeripheral.disconnect({fulfill:function(peripheral){removeNotificationListeners(peripheral);fulfill(self)},reject:reject})})};this.getAllServices=function(serviceUuids){return util.errorLoggingPromise(function(fulfill,reject){reject("Not implemented")})};function getPeripheralSupportedServices(){var allServicesObj=self._gattIpPeripheral.getAllServices();var allServicesArray=Object.keys(allServicesObj);if(filter){return filtersLib.getAllSupportedServices(allServicesArray,filter,optionalServices)}else{return filtersLib.getOptionalServices(allServicesArray,optionalServices)}}this.getService=function(serviceUuid){var self=this;return util.errorLoggingPromise(function(fulfill,reject){if(getPeripheralSupportedServices().indexOf(serviceUuid)!=-1){var vensiUuid=util.toVensiUUID(self._gattIp.BluetoothUUID.getService(serviceUuid));if("undefined"==typeof vensiUuid){reject("Unable to find service with requested UUID "+serviceUuid)}else{var svc=self._gattIpPeripheral.findService(vensiUuid);if(svc){fulfill(new BluetoothGattService(self,svc))}else{svc=self._gattIpPeripheral.findService(serviceUuid);if(svc){console.error("Hack alert: Fix VensiUUID ");fulfill(new BluetoothGattService(self,svc))}else{reject("Service "+serviceUuid+" not found")}}}}else{reject("Service not supported")}})};this.connectGATT=this.connect;this.getPrimaryService=this.getService}module.exports.BluetoothDevice=BluetoothDevice;ee.makeEmitter(BluetoothDevice)},{"./event-emitter":2,"./util.js":5,"./wb-service":10}],9:[function(require,module,exports){var util=require("./util");var INVALID_OPTIONS_ERROR_MESSAGE="Either 'filters' should be present or 'acceptAllDevices' should be true, but not both.";var EMPTY_FILTER_ERROR_MESSAGE="'filters' member must be non-empty to find any devices.";var INVALID_MFR_DATA_FORMAT="Invalid manufacturerData format";var INVALID_SERVICE_DATA_FORMAT="Invalid serviceData format";var invalidServiceUUIDMessage=function(uuid){return"Invalid Service name: '"+uuid+"'. It must be a valid UUID alias (e.g. 0x1234), UUID (lowercase hex characters e.g. '00001234-0000-1000-8000-00805f9b34fb'), or recognized standard name from https://www.bluetooth.com/specifications/gatt/services e.g. 'alert_notification'."};function checkValidFilterMfrData(filter){for(var key in filter.manufacturerData){if(filter.manufacturerData.hasOwnProperty(key)){if(util.isEmpty(filter.manufacturerData[key])||"dataPrefix"in filter.manufacturerData[key]){if("dataPrefix"in filter.manufacturerData[key]){if(filter.manufacturerData[key].dataPrefix instanceof Uint8Array==false){return false}else if("mask"in filter.manufacturerData[key]){if(filter.manufacturerData[key].mask instanceof Uint8Array==false){return false}else if(filter.manufacturerData[key].dataPrefix.byteLength!=filter.manufacturerData[key].mask.byteLength){return false}}}}else{return false}}}return true}function checkValidFilterServiceData(filter){for(var key in filter.serviceData){if(filter.serviceData.hasOwnProperty(key)){if(!util.isEmpty(filter.serviceData[key])){return false}}}return true}function nameFilter(filter,peripheral){if(filter.name){return filter.name===peripheral.name}else{return true}}function servicesFilter(filter,peripheral){if(filter.services){var servicesMatch=true;for(var i=0;i<filter.services.length;i++){if(peripheral.serviceUUIDs.indexOf(filter.services[i].toUpperCase())===-1){servicesMatch=false}}return servicesMatch}else{return true}}function namePrefixFilter(filter,peripheral){if(filter.namePrefix){return peripheral.name.indexOf(filter.namePrefix)>-1}else{return true}}function checkMfrMask(peripheralMfrData,dataPrefix,mask){var mfrDataArray=peripheralMfrData.match(/.{1,2}/g);if(mfrDataArray.length>=dataPrefix.length){for(var i=0;i<dataPrefix.length;i++){if((dataPrefix[i]&mask[i])!=(mfrDataArray[i]&mask[i])){return false}}}else{return false}return true}function manufacturerDataFilter(filter,peripheral){if(filter.manufacturerData){var peripheralMfrData=peripheral.getAllMfrData();if(util.isEmpty(filter.manufacturerData)){return false}else{for(var key in filter.manufacturerData){if(filter.manufacturerData.hasOwnProperty(key)){if(!peripheralMfrData.hasOwnProperty(key)){return false}if(!util.isEmpty(filter.manufacturerData[key])&&"mask"in filter.manufacturerData[key]){if(checkMfrMask(peripheralMfrData[key],filter.manufacturerData[key].dataPrefix,filter.manufacturerData[key].mask)==false){return false}}else{var stringFromUintArray=util.uintArrayToString(filter.manufacturerData[key].dataPrefix);if(peripheralMfrData[key].indexOf(stringFromUintArray)!=0){return false}}}}}return true}else{return true}}function serviceDataFilter(filter,peripheral){if(filter.serviceData){var peripheralSvcData=peripheral.getAllSvcData();if(util.isEmpty(filter.serviceData)){return false}else{for(var key in filter.serviceData){if(filter.serviceData.hasOwnProperty(key)){if(!peripheralSvcData.hasOwnProperty(key)){return false}else if(!util.isEmpty(filter.serviceData[key])){return false}}}}return true}else{return true}}function commonServices(filterUUIDs,uuids){var services=[];for(var m=0;m<uuids.length;m++){for(var d=0;d<filterUUIDs.length;d++){if(filterUUIDs[d].toUpperCase()==uuids[m].toUpperCase()){services.push(filterUUIDs[d])}}}return services}var getFilteredServices=function(allServiceUUIDs,filter){if(filter.hasOwnProperty("services")){return commonServices(filter.services,allServiceUUIDs)}else{return[]}};module.exports.getOptionalServices=function(allServiceUUIDs,optionalServices){if(optionalServices&&optionalServices.length>0){return commonServices(optionalServices,allServiceUUIDs)}else{return[]}};module.exports.getAllSupportedServices=function(allServices,filter,optionalServices){var supportedServices=[];var supportedFilter=getFilteredServices(allServices,filter);var supportedOptional=module.exports.getOptionalServices(allServices,optionalServices);supportedServices=supportedFilter.concat(supportedOptional);return supportedServices};module.exports.checkFilters=function(filters,acceptAllDevices,optionalServices){var response={};if(filters&&filters.length>0&&!acceptAllDevices){for(var i=0;i<filters.length;i++){var currentFilter=filters[i];if(currentFilter.services){for(var j=0;j<currentFilter.services.length;j++){var serviceUUID=currentFilter.services[j];if(!util.isHex(serviceUUID)){response={error:true,message:invalidServiceUUIDMessage(serviceUUID)};return response}}}if(currentFilter.manufacturerData){if(!checkValidFilterMfrData(currentFilter)){response={error:true,message:INVALID_MFR_DATA_FORMAT};return response}}if(currentFilter.serviceData){if(!checkValidFilterServiceData(currentFilter)){response={error:true,message:INVALID_SERVICE_DATA_FORMAT};return response}}}response={error:false,isFiltering:true}}else if((!filters||filters.length==0)&&acceptAllDevices){response={error:false,isFiltering:false}}else if(filters&&filters.length==0){response={error:true,message:EMPTY_FILTER_ERROR_MESSAGE}}else{response={error:true,message:INVALID_OPTIONS_ERROR_MESSAGE}}if(optionalServices&&optionalServices.length>0){for(var k=0;k<optionalServices.length;k++){if(!util.isHex(optionalServices[k])){response={error:true,message:invalidServiceUUIDMessage(optionalServices[k])};break}}}return response};module.exports.filterScan=function(peripheral,filters,optionalServices){if(peripheral.advdata&&peripheral.advdata.serviceUUIDs.length>0){peripheral.serviceUUIDs=peripheral.advdata.serviceUUIDs}else{peripheral.serviceUUIDs=peripheral.getAllAdvertisedServiceUUIDs()}for(var i=0;i<filters.length;i++){var nameMatch=nameFilter(filters[i],peripheral);var prefixMatch=namePrefixFilter(filters[i],peripheral);var servicesMatch=servicesFilter(filters[i],peripheral);var manufacturerDataMatch=manufacturerDataFilter(filters[i],peripheral);var serviceDataMatch=serviceDataFilter(filters[i],peripheral);if(nameMatch&&prefixMatch&&servicesMatch&&manufacturerDataMatch&&serviceDataMatch){return{peripheral:peripheral,filter:filters[i]}}}return false}},{"./util":5}],10:[function(require,module,exports){var util=require("./util.js");var BluetoothGattCharacteristic=require("./wb-characteristic").BluetoothGattCharacteristic;function BluetoothGattService(device,gattipService){this._gattIp=device._gattIp;this._device=device;this._gattIpService=gattipService}module.exports.BluetoothGattService=BluetoothGattService;BluetoothGattService.prototype={get uuid(){return util.toWbUUID(this._service.uuid)},get isPrimary(){return true},get device(){return this._device},getCharacteristic:function(characteristicUuid){var self=this;return util.errorLoggingPromise(function(fulfill,reject){var vensiUuid=util.toVensiUUID(self._gattIp.BluetoothUUID.getCharacteristic(characteristicUuid));if("undefined"==typeof vensiUuid){reject("Unable to find characteristic with requested UUID "+characteristicUuid)}else{var char=self._gattIpService.findCharacteristic(vensiUuid);if(char){fulfill(new BluetoothGattCharacteristic(self,char))}else{char=self._gattIpService.findCharacteristic(characteristicUuid);if(char){console.error("Hack alert: Fix VensiUUID ");fulfill(new BluetoothGattCharacteristic(self,char))}else{reject("Characteristic "+characteristicUuid+" not found")}}}})},getIncludedService:function(serviceUuid){return util.errorLoggingPromise(function(fulfill,reject){reject("Not implemented")})}}},{"./util.js":5,"./wb-characteristic":6}],11:[function(require,module,exports){},{}],12:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}throw TypeError('Uncaught, unspecified "error" event.')}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}}else if(isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){var m;if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-- >0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else{while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],13:[function(require,module,exports){var C=require("./lib/constants.js").C;var helper=require("./lib/message-helper");var ee=require("./lib/event-emitter");var Descriptor=require("./descriptor").Descriptor;function Characteristic(service,uuid,props){ee.instantiateEmitter(this);var self=this;var peripheral=service.peripheral();var gattip=peripheral.gattip();var descriptors={};var properties={};helper.requireUUID("Characteristic","uuid",uuid);this.uuid=uuid;if(!props){props={}}properties=props;this.type="c";this.isNotifying=false;this.gattip=function(){return gattip};this.peripheral=function(){return peripheral};this.service=function(){return service};this.getAllDescriptors=function(){return descriptors};this.findDescriptor=function(uuid){return descriptors[uuid]};this.addDescriptorWithUUID=function(descriptorUUID){var descriptor=new Descriptor(self,descriptorUUID);return descriptors[descriptorUUID]=descriptor};this.addDescriptor=function(descriptor){return descriptors[descriptor.uuid]=descriptor};this.hasProperty=function(type){return properties[type]&&properties[type].enabled};this.setProperty=function(type,value){return properties[type]=value};this.allProperties=function(){return properties};this.readValue=function(callback){var params=helper.populateParams(self);gattip.request(C.kGetCharacteristicValue,params,callback,function(params){helper.requireFields("Value",params,[C.kValue],[]);self.value=params[C.kValue];gattip.fulfill(callback,self,self.value)})};this.writeValue=function(callback,value){helper.requireHexValue("writeValue","value",value);var params=helper.populateParams(self);params[C.kValue]=value;gattip.request(C.kWriteCharacteristicValue,params,callback,function(params){self.value=value;gattip.fulfill(callback,self)})};this.enableNotifications=function(callback,isNotifying){helper.requireBooleanValue("enableNotifications","isNotifying",isNotifying);var params=helper.populateParams(self);params[C.kIsNotifying]=isNotifying;gattip.request(C.kSetValueNotification,params,callback,function(params){self.isNotifying=isNotifying;gattip.fulfill(callback,self,isNotifying)})};this.handleValueNotification=function(params){self.value=params[C.kValue];self.emit("valueChange",self,self.value)};this.respondToReadRequest=function(cookie,value){helper.requireHexValue("respondToReadRequest","value",value);var params=helper.populateParams(self);params[C.kValue]=value;cookie.result=C.kGetCharacteristicValue;gattip.respond(cookie,params)};this.respondToWriteRequest=function(cookie){var params=helper.populateParams(self);cookie.result=C.kWriteCharacteristicValue;gattip.respond(cookie,params)};this.respondToChangeNotification=function(cookie,isNotifying){var params=helper.populateParams(self);helper.requireBooleanValue("respondToChangeNotification","value",isNotifying);params[C.kIsNotifying]=isNotifying;this.isNotifying=isNotifying;cookie.result=C.kSetValueNotification;gattip.respond(cookie,params)};this.indicateValueChange=function(value){helper.requireHexValue("writeValue","value",value);var params=helper.populateParams(self);params[C.kValue]=value;gattip.sendIndications(C.kSetValueNotification,params)}}ee.makeEmitter(Characteristic);module.exports.Characteristic=Characteristic},{"./descriptor":14,"./lib/constants.js":18,"./lib/event-emitter":19,"./lib/message-helper":22}],14:[function(require,module,exports){var C=require("./lib/constants.js").C;var helper=require("./lib/message-helper");function Descriptor(characteristic,uuid){var self=this;var service=characteristic.service();var peripheral=service.peripheral();var gattip=peripheral.gattip();helper.requireUUID("Descriptor","uuid",uuid);this.uuid=uuid;this.type="d";this.characteristic=function(){return characteristic};this.service=function(){return service};this.peripheral=function(){return peripheral};this.gattip=function(){return gattip};this.readValue=function(callback){var params=helper.populateParams(self);gattip.request(C.kGetDescriptorValue,params,callback,function(params){helper.requireFields("readValue",params,[C.kValue],[]);self.value=params[C.kValue];gattip.fulfill(callback,self,self.value)})};this.writeValue=function(callback,value){var params=helper.populateParams(self);helper.requireHexValue("writeValue","value",value);gattip.request(C.kWriteDescriptorValue,params,callback,function(params){self.value=value;gattip.fulfill(callback,self)})};this.respondToReadRequest=function(cookie,value){var params=helper.populateParams(self);helper.requireHexValue("respondToReadRequest","value",value);params[C.kValue]=value;gattip.respond(cookie,params)};this.respondToWriteRequest=function(cookie){var params=helper.populateParams(self);gattip.respond(cookie,params)}}module.exports.Descriptor=Descriptor},{"./lib/constants.js":18,"./lib/message-helper":22}],15:[function(require,module,exports){module.exports.ApplicationError=function(message){this.message="Application Error:"+message;Error.captureStackTrace(this,module.exports.ApplicationError)};module.exports.InternalError=function(message){this.message="Application Error:"+message;Error.captureStackTrace(this,module.exports.InternalError)};module.exports.GatewayError=function(params){if(typeof params=="object"){this.message="Gateway Error:";if(params.message){this.message+=" "+params.message}if(params.code){this.message+=" Code:"+params.code}if(0==this.message.length){this.message="Unknown Gateway Error"}}else{this.message=params}Error.captureStackTrace(this,module.exports.GatewayError)}},{}],16:[function(require,module,exports){var C=require("./lib/constants").C;var helper=require("./lib/message-helper");var Peripheral=require("./peripheral").Peripheral;var Stream=require("./stream").Stream;var InternalError=require("./errors").InternalError;var ApplicationError=require("./errors").ApplicationError;var ee=require("./lib/event-emitter");var GatewayError=require("./errors").GatewayError;function Gateway(gattip,scanFilters){ee.instantiateEmitter(this);var self=this;var peripherals={};var objectsByObjectId={};this.isScanning=false;this.isPoweredOn=function(){return self.state==C.kPoweredOn};this._authenticate=function(callback,token,version){var params={};params[C.kDeviceAccessToken]=token;params[C.kGetVersionInfo]=version;gattip.request(C.kOpen,params,callback,function(params){if(params&&params.isAuthenticated===false){gattip.reject(callback,new GatewayError("Authentication failed"))}else{gattip.fulfill(callback,self)}})};this.scan=function(callback,scanOptions){var params={};if(scanOptions){if("boolean"==typeof scanOptions.scanDuplicates){params[C.kScanOptionAllowDuplicatesKey]=scanOptions.scanDuplicates}if("object"==typeof scanOptions.services){params[C.kServiceUUIDs]=scanOptions.services}}gattip.request(C.kScanForPeripherals,params,callback,function(params){self.isScanning=true;gattip.fulfill(callback,self)})};this.stopScan=function(callback){gattip.request(C.kStopScanning,{},callback,function(params){self.isScanning=false;gattip.fulfill(callback,self)})};this.centralState=function(callback){var params={};gattip.request(C.kCentralState,{},callback,function(params){self.state=params[C.kState];gattip.fulfill(callback,self)})};this.configure=function(callback,pwrAlert,centralID){var params={};if(typeof pwrAlert!="undefined"){params[C.kShowPowerAlert]=pwrAlert}if(typeof centralID!="undefined"){params[C.kIdentifierKey]=centralID}gattip.request(C.kConfigure,{},callback,function(params){gattip.fulfill(callback,self)})};this.openStream=function(callback,streamPath,options){var params={};if(!options){options={}}if(typeof options.speed=="number"){params[C.kSpeed]=options.speed}if(typeof options.force=="boolean"){params[C.kForce]=options.force}var streamObjectId=params[C.kObjectId]=streamPath;helper.requireFields("objectId",params,[C.kObjectId]);gattip.request(C.kOpenStream,params,callback,function(params){if(typeof params[C.kObjectId]=="string"){streamObjectId=params[C.kObjectId]}var stream=new Stream(this,streamObjectId);objectsByObjectId[streamObjectId]=stream;gattip.fulfill(callback,stream)})};this.closeStream=function(callback,objectId){var params={};var streamObjectId=params[C.kObjectId]=objectId;helper.requireFields("objectId",params,[C.kObjectId]);gattip.request(C.kCloseStream,params,callback,function(params){var stream=objectsByObjectId[streamObjectId];delete objectsByObjectId[streamObjectId];gattip.fulfill(callback,stream)})};this.handleScanIndication=function(params){var peripheralUUID=params[C.kPeripheralUUID];if(!peripheralUUID){throw new InternalError("Peripheral UUID is not availabvle")}if(scanFilters&&scanFilters.uuids){for(var i=0;i<scanFilters.uuids.length;i++){var uuid=scanFilters.uuids[i];if(uuid&&uuid.length){if(uuid!=peripheralUUID){return}}}}var peripheral=self.getPeripheral(peripheralUUID);if(!peripheral){peripheral=self.addPeripheral(new Peripheral(gattip,peripheralUUID,params[C.kPeripheralName],params[C.kRSSIkey],params[C.kCBAdvertisementDataTxPowerLevel],params[C.kCBAdvertisementDataIsConnectable],params[C.kCBAdvertisementDataServiceUUIDsKey],params[C.kCBAdvertisementDataManufacturerDataKey],params[C.kCBAdvertisementDataServiceDataKey],params[C.kAdvertisementDataKey],params[C.kScanRecord]))}else{peripheral._updateFromScanData(params[C.kPeripheralName],params[C.kRSSIkey],params[C.kCBAdvertisementDataTxPowerLevel],params[C.kCBAdvertisementDataIsConnectable],params[C.kCBAdvertisementDataServiceUUIDsKey],params[C.kCBAdvertisementDataManufacturerDataKey],params[C.kCBAdvertisementDataServiceDataKey],params[C.kAdvertisementDataKey],params[C.kScanRecord])}self.emit("scan",peripheral)};this.addPeripheralWithValues=function(uuid,name,RSSI,txPwr,serviceUUIDs,mfrData,scvData,connectable){if(!uuid){throw new InternalError("Attempting to add an empty peripheral")}var peripheral=self.addPeripheral(new Peripheral(gattip,uuid,name,RSSI,txPwr,connectable,serviceUUIDs,mfrData,scvData));peripherals[uuid]=peripheral;return peripheral};this.addPeripheral=function(peripheral){if(!peripheral||!peripheral.uuid){throw new InternalError("Attempting to add an empty peripheral")}peripherals[peripheral.uuid]=peripheral;return peripheral};this.addStream=function(objectId){var stream=new Stream(this,objectId);objectsByObjectId[objectId]=stream;return stream};this.removePeripheral=function(peripheral){if(!peripheral||!peripheral.uuid){throw new InternalError("Attempting to remove an empty peripheral")}delete peripherals[peripheral.uuid]};this.getPeripheral=function(peripheralUUID){return peripherals[peripheralUUID]};this.getObject=function(objectId){return objectsByObjectId[objectId]};this.removeObject=function(objectId){delete objectsByObjectId[objectId]};this.getPeripheralOrDie=function(peripheralUUID){var peripheral=peripherals[peripheralUUID];if(!peripheral){throw new InternalError("Unable to find peripheral with UUID "+peripheralUUID)}return peripheral};this.getObjects=function(type,peripheralUUID,serviceUUID,characteristicUUID,descriptorUUID){var resultObj={};resultObj.peripheral=peripherals[peripheralUUID];if(resultObj.peripheral){if(type==="p"){return resultObj}resultObj.service=resultObj.peripheral.findService(serviceUUID);if(resultObj.service){if(type==="s"){return resultObj}resultObj.characteristic=resultObj.service.findCharacteristic(characteristicUUID);if(resultObj.characteristic){if(type==="c"){return resultObj}resultObj.descriptor=resultObj.characteristic.findDescriptor(descriptorUUID);if(resultObj.descriptor){if(type==="d"){return resultObj}else{throw new InternalError('_getObjects: Argument "type" is required')}}else{throw new ApplicationError('Descriptor "'+descriptorUUID+'" not found in the service table')}}else{throw new ApplicationError('Characteristic "'+characteristicUUID+'" not found in the service table')}}else{throw new ApplicationError('Service "'+serviceUUID+'" not found in the service table')}}else{throw new ApplicationError("Peripheral with id "+peripheralUUID+" not found")}};this.getObjectsFromMessage=function(type,params){if(!params){throw new InternalError("Message parameters are missing")}try{return self.getObjects(type,params[C.kPeripheralUUID],params[C.kServiceUUID],params[C.kCharacteristicUUID],params[C.kDescriptorUUID])}catch(error){throw new InternalError(error.message,error.detail)}}}ee.makeEmitter(Gateway);module.exports.Gateway=Gateway},{"./errors":15,"./lib/constants":18,"./lib/event-emitter":19,"./lib/message-helper":22,"./peripheral":26,"./stream":28}],17:[function(require,module,exports){var ee=require("./lib/event-emitter");var InternalError=require("./errors").InternalError;var ApplicationError=require("./errors").ApplicationError;var GatewayError=require("./errors").GatewayError;var MessageHandler=require("./lib/message-handler").MessageHandler;var MessageProcessor=require("./lib/message-processor").MessageProcessor;var Gateway=require("./gateway").Gateway;var helper=require("./lib/message-helper");var ServerMessageHandler=require("./lib/server-message-handler").ServerMessageHandler;var NODE_CLIENT_SOCKET_CONFIG={keepalive:true,dropConnectionOnKeepaliveTimeout:true,keepaliveInterval:1e4,keepaliveGracePeriod:1e4};function GATTIP(){ee.instantiateEmitter(this);this.traceEnabled=false;var self=this;var stream;var processor;var mh;var smh;var gateway;this.getGateway=function(){return gateway};this.traceMessage=function(message,prefix){if(self.traceEnabled){if("object"==typeof message){message=JSON.stringify(message)}console.log(prefix?prefix:"",message)}};function sendError(err){self.emit("error",err)}this.getServerMessageHandler=function(){if(!smh){sendError(new GatewayError("Server Message Handler is not Ready"))}return smh};this.fulfill=function(cb,arg1,arg2,arg3,arg4,arg5){if(typeof cb=="object"&&typeof cb.fulfill=="function"){cb.fulfill(arg1,arg2,arg3,arg4,arg5)}else if(typeof cb=="function"){cb(arg1,arg2,arg3,arg4,arg5)}};this.reject=function(cb,error){if(typeof cb=="object"&&typeof cb.reject=="function"){cb.reject(error)}else{sendError(error)}};function guardedProcessMessage(doParse,message,handlerFunc){try{if(doParse){message=JSON.parse(message)}handlerFunc(message)}catch(error){sendError(error)}}this.open=function(config){var gw=new Gateway(this,config.scanFilters);processor=new MessageProcessor(this);mh=new MessageHandler(this,gw);smh=new ServerMessageHandler(this,gw);function waitReady(config){if(config.isServer){processor.on("request",function(message){self.traceMessage(message,"<req:");guardedProcessMessage(false,message,smh.processMessage)});processor.on("indication",function(message){sendError(new ApplicationError("Received an indication on a server stream:"+JSON.stringify(message)))});gateway=gw;self.emit("ready",gw)}else if(config.isPassThrough){emitGateway()}else{gw.configure(function(){gw.centralState(function(){if(!gw.isPoweredOn()){console.log("Bluetooth not power on :(");self.emit("state",gw.isPoweredOn());var statePoll=setInterval(function(){gw.centralState(function(){if(gw.isPoweredOn()){self.emit("state",gw.isPoweredOn());clearInterval(statePoll);emitGateway()}})},500)}else if(gw.isPoweredOn()){emitGateway()}})})}}function emitGateway(){processor.on("indication",function(message){self.traceMessage(message,"<ind:");guardedProcessMessage(false,message,mh.handleIndication)});processor.on("request",function(message){sendError(new InternalError("Received a request on a client stream:"+JSON.stringify(message)))});gateway=gw;self.emit("ready",gw)}function doOpen(config){if(config.token){gw._authenticate(function(){waitReady(config)},config.token,config.version)}else{waitReady(config)}}if(config.trace===true){self.traceEnabled=true}if(config.url){var WebSocket;if(typeof window=="object"){WebSocket=window.WebSocket}else{WebSocket=require("websocket").w3cwebsocket}stream=new WebSocket(config.url,undefined,undefined,undefined,undefined,NODE_CLIENT_SOCKET_CONFIG);stream.onopen=function(){doOpen(config)};stream.onclose=function(error){self.emit("onclose",error)};stream.onerror=function(error){self.emit("onerror",error)}}else if(config.stream){stream=config.stream;doOpen(config)}else{throw new ApplicationError("URL or stream implementing a socket interface is required")}stream.onmessage=function(streamMessage){guardedProcessMessage(true,streamMessage.data,processor.onMessageReceived)};processor.on("response",function(message,ctxt){self.traceMessage(message,"<rsp:");try{if(message.error){self.reject(ctxt.cb,new GatewayError(message.error))}else{if(ctxt.handler){ctxt.handler(message.params)}else{self.fulfill(ctxt.cb)}}}catch(error){self.reject(ctxt.cb,error)}});processor.on("error",function(error){self.emit("error",error)})};this.close=function(){if(stream){stream.close()}};this.getCommunicationStream=function(){return stream};this.request=function(method,params,userCb,handler){var ctxt=mh.createUserContext(method,params,userCb,handler);var msg=ctxt.originalMessage;processor.register(msg,ctxt);self.traceMessage(msg,">req:");stream.send(JSON.stringify(msg))};this.respond=function(cookie,params){var msg=mh.wrapResponse(cookie,params);self.traceMessage(msg,">rsp:");stream.send(JSON.stringify(msg))};this.sendIndications=function(result,params){var mesg={params:params,jsonrpc:"2.0"};mesg.result=result;mesg.params=params;self.traceMessage(mesg,">rsp:");stream.send(JSON.stringify(mesg))};this.sendError=function(mesg){mesg.jsonrpc="2.0";self.traceMessage(mesg,">rsp:");stream.send(JSON.stringify(mesg))}}ee.makeEmitter(GATTIP);module.exports.GATTIP=GATTIP},{"./errors":15,"./gateway":16,"./lib/event-emitter":19,"./lib/message-handler":21,"./lib/message-helper":22,"./lib/message-processor":23,"./lib/server-message-handler":24,websocket:11}],18:[function(require,module,exports){var C={DEFAULT_MESSAGE_TIMEOUT_MS:61e3,MAX_PENDING_MESSAGES:200,NUM_CONNECT_ATTEMPTS:3,kMessageId:"id",kSessionId:"session_id",kObjectId:"oid",kAuthenticate:"aut",kOpen:"opn",kDeviceAccessToken:"dat",kGetVersionInfo:"vif",kOpenStream:"ops",kCloseStream:"cls",kStreamClosedIndication:"cis",kWriteStreamData:"wsd",kStreamDataIndication:"sdi",kVal:"val",kSpeed:"spd",kForce:"frc",kError:"error",kCode:"code",kMessageField:"message",kMethod:"method",kResult:"result",kIdField:"id",kConfigure:"aa",kScanForPeripherals:"ab",kStopScanning:"ac",kConnect:"ad",kDisconnect:"ae",kCentralState:"af",kGetConnectedPeripherals:"ag",kGetPerhipheralsWithServices:"ah",kGetPerhipheralsWithIdentifiers:"ai",kGetServices:"ak",kGetIncludedServices:"al",kGetCharacteristics:"am",kGetDescriptors:"an",kGetCharacteristicValue:"ao",kGetDescriptorValue:"ap",kWriteCharacteristicValue:"aq",kWriteDescriptorValue:"ar",kSetValueNotification:"as",kGetPeripheralState:"at",kGetRSSI:"au",kInvalidatedServices:"av",kPeripheralNameUpdate:"aw",kMessage:"zz",kCentralUUID:"ba",kPeripheralUUID:"bb",kPeripheralName:"bc",kPeripheralUUIDs:"bd",kServiceUUID:"be",kServiceUUIDs:"bf",kPeripherals:"bg",kIncludedServiceUUIDs:"bh",kCharacteristicUUID:"bi",kCharacteristicUUIDs:"bj",kDescriptorUUID:"bk",kServices:"bl",kCharacteristics:"bm",kDescriptors:"bn",kProperties:"bo",kValue:"bp",kState:"bq",kStateInfo:"br",kStateField:"bs",kWriteType:"bt",kRSSIkey:"bu",kIsPrimaryKey:"bv",kIsBroadcasted:"bw",kIsNotifying:"bx",kShowPowerAlert:"by",kIdentifierKey:"bz",kScanOptionAllowDuplicatesKey:"b0",kScanOptionSolicitedServiceUUIDs:"b1",kAdvertisementDataKey:"b2",kCBAdvertisementDataManufacturerDataKey:"mfr",kCBAdvertisementDataServiceUUIDsKey:"suu",kCBAdvertisementDataServiceDataKey:"sdt",kCBAdvertisementDataOverflowServiceUUIDsKey:"b6",kCBAdvertisementDataSolicitedServiceUUIDsKey:"b7",kCBAdvertisementDataIsConnectable:"cbl",kCBAdvertisementDataTxPowerLevel:"txp",kPeripheralBtAddress:"c1",kRawAdvertisementData:"c2",kScanRecord:"c3",kCBCentralManagerRestoredStatePeripheralsKey:"da",kCBCentralManagerRestoredStateScanServicesKey:"db",kWriteWithResponse:"cc",kWriteWithoutResponse:"cd",kNotifyOnConnection:"ce",kNotifyOnDisconnection:"cf",kNotifyOnNotification:"cg",kDisconnected:"ch",kConnecting:"ci",kConnected:"cj",kUnknown:"ck",kResetting:"cl",kUnsupported:"cm",kUnauthorized:"cn",kPoweredOff:"co",kPoweredOn:"cp",kErrorPeripheralNotFound:"-32001",kErrorServiceNotFound:"-32002",kErrorCharacteristicNotFound:"-32003",kErrorDescriptorNotFound:"-32004",kErrorPeripheralStateIsNotValid:"-32005",kErrorNoServiceSpecified:"-32006",kErrorNoPeripheralIdentiferSpecified:"-32007",kErrorStateRestorationNotValid:"-32008",kInvalidRequest:"-32600",kMethodNotFound:"-32601",kInvalidParams:"-32602",kError32603:"-32603",kParseError:"-32700",kGAP_ADTYPE_FLAGS:"01",kGAP_ADTYPE_INCOMPLETE_16BIT_SERVICEUUID:"02",kGAP_ADTYPE_COMPLETE_16BIT_SERVICEUUID:"03",kGAP_ADTYPE_INCOMPLETE_32BIT_SERVICEUUID:"04",kGAP_ADTYPE_COMPLETE_32BIT_SERVICEUUID:"05",kGAP_ADTYPE_INCOMPLETE_128BIT_SERVICEUUID:"06",kGAP_ADTYPE_COMPLETE_128BIT_SERVICEUUID:"07",kGAP_ADTYPE_POWER_LEVEL:"0A",kGAP_ADTYPE_MANUFACTURER_SPECIFIC:"FF",kGAP_ADTYPE_16BIT_SERVICE_DATA:"16",id:1,authenticate:"authenticate",AllProperties:["Broadcast","Read","WriteWithoutResponse","Write","Notify","Indicate","AuthenticatedSignedWrites","ExtendedProperties","NotifyEncryptionRequired","IndicateEncryptionRequired"]};module.exports.C=C},{}],19:[function(require,module,exports){var EventEmitter=require("events");var util=require("util");module.exports.makeEmitter=function(contructor){util.inherits(contructor,EventEmitter)};module.exports.instantiateEmitter=function(object){EventEmitter.call(object)}},{events:12,util:32}],20:[function(require,module,exports){var C=require("./constants").C;function getDiscoverable(advdata,advArray){var discoverableDataLength=parseInt(advArray[0],16);if(parseInt(advArray[2],16)>=1){advdata.connectable="true"}else advdata.connectable="false";advArray.splice(0,discoverableDataLength+1)}function getTXLevel(advdata,advArray){var txlevelDataLength=parseInt(advArray[0],16);advdata.txPowerLevel=parseInt(advArray[2]);advArray.splice(0,txlevelDataLength+1)}function getManufacturerData(advdata,advArray){var manufacturerDataLength=parseInt(advArray[0],16);if(manufacturerDataLength>2){var mfrKey=advArray[3]+advArray[2];var mfrData="";for(var k=4;k<=manufacturerDataLength;k++){mfrData+=advArray[k]}advdata.manufacturerData[mfrKey]=mfrData}advArray.splice(0,manufacturerDataLength+1)}function getServiceUUIDs(advdata,advArray){var service16bitDataLength=parseInt(advArray[0],16);var reverse16bitUUID="";for(var i=service16bitDataLength;i>=2;i--){reverse16bitUUID+=advArray[i]}advdata.serviceUUIDs=reverse16bitUUID;advArray.splice(0,service16bitDataLength+1)}function get128bitServiceUUIDs(advdata,advArray){var service128bitDataLength=parseInt(advArray[0],16);var reverse128bitUUID="";for(var i=service128bitDataLength;i>=2;i--){reverse128bitUUID+=advArray[i];if(i==14||i==12||i==10||i==8){reverse128bitUUID+="-"}}advdata.serviceUUIDs=reverse128bitUUID;advArray.splice(0,service128bitDataLength+1)}function getServiceData(advdata,advArray){var serviceDataLength=parseInt(advArray[0],16);var eddystoneServiceUUID="";for(var i=3;i>=2;i--){eddystoneServiceUUID+=advArray[i]}if(eddystoneServiceUUID=="FEAA"){if(parseInt(advArray[4],16)===0){getUID(advdata)}else if(parseInt(advArray[4],16)==16){getURL(advdata)}else if(parseInt(advArray[4],16)==32){getTLM(advdata)}}advArray.splice(0,serviceDataLength+1)}function getUID(advdata,advArray){advdata.frameType="UID";advdata.nameSpace="";advdata.instanceID="";advdata.txPowerLevel=parseInt(advArray[5],16);for(var i=6;i<16;i++){advdata.nameSpace+=advArray[i]}for(var j=16;j<22;j++){advdata.instanceID+=advArray[j]}advdata.reserved=advArray[22];advdata.reserved+=advArray[23]}function getURL(advdata,advArray){advdata.frameType="URL";advdata.txPowerLevel=parseInt(advArray[5]);for(var protocol in C.AllProtocols){if(advArray[6]==protocol)advdata.url=C.AllProtocols[protocol]}for(var i=7;i<advArrayLength;i++){advdata.url+=String.fromCharCode(parseInt(advArray[i],16))}for(var domain in C.AllDomains){if(advArray[advArrayLength]==domain)advdata.url+=C.AllDomains[domain]}}function getTLM(advdata,advArray){advdata.frameType="TLM";advdata.advPacketCount="";advdata.timeInterval="";advdata.batteryVoltage="";advdata.eddyVersion=parseInt(advArray[5],16);for(var i=6;i<8;i++){advdata.batteryVoltage+=advArray[i]}advdata.batteryVoltage=parseInt(advdata.batteryVoltage,16);advdata.temperature=Math.ceil(parseInt(advArray[8],16));advdata.temperature+=".";var temp=Math.ceil(1/256*parseInt(advArray[9],16));if(temp.length>2)advdata.temperature+=temp.toString().substring(0,2);else advdata.temperature+=temp;for(var j=10;j<14;j++){advdata.advPacketCount+=advArray[j]}advdata.advPacketCount=parseInt(advdata.advPacketCount,16);for(var k=14;k<18;k++){advdata.timeInterval+=advArray[k]}advdata.timeInterval=Math.ceil(parseInt(advdata.timeInterval,16)*.1);advdata.timePeriod="";if(advdata.timeInterval>=60){var days=Math.floor(advdata.timeInterval/86400);if(days>0){advdata.timePeriod+=days<10?days+"day ":days+"days ";advdata.timeInterval-=days*24*60*60}var hours=Math.floor(advdata.timeInterval/3600);if(hours>0){advdata.timePeriod+=hours<10?"0"+hours+":":hours+":";advdata.timeInterval-=hours*60*60}else advdata.timePeriod+="00:";var min=Math.floor(advdata.timeInterval/60);if(min>0){advdata.timePeriod+=min<10?"0"+min+":":min+":";advdata.timeInterval-=min*60;advdata.timePeriod+=advdata.timeInterval<10?"0"+advdata.timeInterval:advdata.timeInterval;advdata.timePeriod+=" secs";advdata.timeInterval=0}else{advdata.timePeriod+="00:"+advdata.timeInterval;advdata.timeInterval=0}}else if(advdata.timeInterval>0&&advdata.timeInterval<60){advdata.timePeriod+=advdata.timeInterval<10?"00:00:0"+advdata.timeInterval:"00:00:"+advdata.timeInterval;advdata.timePeriod+=" secs"}}module.exports.parseAdvArray=function(peripheral,rawAdvertisingData){if(!peripheral.advdata){peripheral.advdata={}}var advdata=peripheral.advdata;if(!advdata.manufacturerData){advdata.manufacturerData={}}if(!advdata.serviceUUIDs){advdata.serviceUUIDs=[]}if(!rawAdvertisingData){return[]}var advArray=[];if(rawAdvertisingData.length%2===0){for(var i=0;i<rawAdvertisingData.length;i=i+2){advArray[i/2]=rawAdvertisingData.charAt(i)+rawAdvertisingData.charAt(i+1)}}else{for(var j=0;j<rawAdvertisingData.length;j++){advArray[j]=rawAdvertisingData.charAt(2*j)+rawAdvertisingData.charAt(2*j+1)}}do{var type=advArray[1];if(type==C.kGAP_ADTYPE_FLAGS){getDiscoverable(advdata,advArray)}else if(type==C.kGAP_ADTYPE_POWER_LEVEL){getTXLevel(advdata,advArray)}else if(type==C.kGAP_ADTYPE_INCOMPLETE_16BIT_SERVICEUUID||type==C.kGAP_ADTYPE_COMPLETE_16BIT_SERVICEUUID){getServiceUUIDs(advdata,advArray)}else if(type==C.kGAP_ADTYPE_INCOMPLETE_32BIT_SERVICEUUID||type==C.kGAP_ADTYPE_COMPLETE_32BIT_SERVICEUUID){getServiceUUIDs(advdata,advArray)}else if(type==C.kGAP_ADTYPE_INCOMPLETE_128BIT_SERVICEUUID||type==C.kGAP_ADTYPE_COMPLETE_128BIT_SERVICEUUID){get128bitServiceUUIDs(advdata,advArray)}else if(type==C.kGAP_ADTYPE_MANUFACTURER_SPECIFIC){getManufacturerData(advdata,advArray)}else if(type==C.kGAP_ADTYPE_16BIT_SERVICE_DATA){getServiceData(advdata,advArray)}else if(type=="00"){advArray.splice(0,1)}else{var advArrayLength=parseInt(advArray[0],16);advArray.splice(0,advArrayLength+1)}if(advArray.length===0){break}}while(true)}},{"./constants":18}],21:[function(require,module,exports){var C=require("./constants").C;var helper=require("./message-helper");var InternalError=require("./../errors").InternalError;var ApplicationError=require("./../errors").ApplicationError;module.exports.MessageHandler=function(gattip,gateway){var self=this;this.createUserContext=function(method,params,userCallback,handler){var mesg={method:method,params:params,jsonrpc:"2.0"};return{originalMessage:mesg,cb:userCallback,handler:handler}};this.wrapResponse=function(cookie,params){var mesg={params:params,jsonrpc:"2.0"};helper.requireAndPopulateFieldsFromCookie("wrapResponse",cookie,mesg);return mesg};this.handleIndication=function(response){if(response.error){throw new ApplicationError(JSON.stringify(response))}var params=response.params;switch(response.result){case C.kScanForPeripherals:var peripheral=gateway.handleScanIndication(params);break;case C.kDisconnect:(function(){helper.requireFields("Disconnect indication",params,[C.kPeripheralUUID]);var peripheral=gateway.getPeripheral(params[C.kPeripheralUUID]);if(peripheral){peripheral.handleDisconnectIndication(peripheral)}else{console.warn("Received disconnect indication for an unknown peripheral with UUID",params[C.kPeripheralUUID])}})();break;case C.kSetValueNotification:(function(){helper.requireFields("Disconnect indication",params,[C.kPeripheralUUID]);var peripheral=gateway.getPeripheral(params[C.kPeripheralUUID]);if(peripheral){helper.requireFields("Value notification",params,[C.kPeripheralUUID,C.kServiceUUID,C.kCharacteristicUUID,C.kValue]);var objs=gateway.getObjectsFromMessage("c",response.params);objs.characteristic.handleValueNotification(params)}else{console.warn("Received value notification for an unknown peripheral with UUID",params[C.kPeripheralUUID])}})();break;case C.kStreamDataIndication:(function(){helper.requireFields("Object ID for stream data",params,[C.kObjectId]);var stream=gateway.getObject(params[C.kObjectId]);if(stream){stream.handleDataIndication(params)}else{console.warn("Received stream data indication for unknown stream",params[C.kObjectId])}})();break;case C.kStreamClosedIndication:(function(){helper.requireFields("Object ID for stream close",params,[C.kObjectId]);var stream=gateway.getObject(params[C.kObjectId]);if(stream){stream.handleDataIndication(params)}else{console.warn("Received stream closed indication for unknown stream",params[C.kObjectId])}})();break;default:(function(){throw new InternalError("Unknown indication received from the gateway:",JSON.stringify(response))})();break}}}},{"./../errors":15,"./constants":18,"./message-helper":22}],22:[function(require,module,exports){var C=require("./constants").C;var constantNames={};var InternalError=require("./../errors").InternalError;var ApplicationError=require("./../errors").ApplicationError;for(var name in C){var code=C[name];if(name.indexOf("k")==0){name=name.substring(1,name.length);constantNames[code]=name}}module.exports.isEmpty=function(obj){for(var prop in obj){if(obj.hasOwnProperty(prop))return false}return JSON.stringify(obj)===JSON.stringify({})};module.exports.arrayAsHex=function(array,pretty){var ret=pretty?"0x":"";for(var i in array){var value=(array[i]&255).toString(16);if(value.length==1){value="0"+value}ret+=value}return ret};function recursiveToString(obj){var ret="";if(typeof obj=="object"){if(Array.isArray(obj)){var val="";for(var i in obj){if(0!=i){ret+=" ,"}ret+=obj[i]}}for(var name in obj){if(obj.hasOwnProperty(name)){var value=obj[name];var constantName=constantNames[name];if(!constantName){constantName=name}if("object"==typeof value){if(Array.isArray(value)){ret+=" "+constantName+":["+recursiveToString(value)+"]"}else{ret+=" "+constantName+":{"+recursiveToString(value)+"}"}}else{ret+=" "+constantName+"="+value}}}}return ret}module.exports.toString=function(message){return recursiveToString(message.params).trim()};module.exports.requireAndAssignParameters=function(callDescription,object,fields,values){module.exports.requireFields(callDescription+" call parameters ",object,fields,values)};module.exports.requireBooleanValue=function(description,parameterName,value){if(typeof value!="boolean"){throw new ApplicationError(description+" missing parameter "+parameterName)}};module.exports.requireHexValue=function(description,parameterName,value){if(typeof value!="string"){throw new ApplicationError(description+" missing parameter "+parameterName)}if(value.length>0&&(value.length%2!=0||!/^[0-9a-fA-F]+$/.test(value))){throw new ApplicationError(description+" value "+parameterName+" is not a valid hex string")}};module.exports.requireUUID=function(description,parameterName,value){if(typeof value!="string"){throw new ApplicationError(description+" missing parameter "+parameterName)}if(value.length<4||!/^[0-9A-F-]+$/.test(value)){throw new ApplicationError(description+" value "+parameterName+" is not a valid UUID")}};module.exports.requireHexValues=function(description,parameterNames,hexValues){var missingFields=[];if(!Array.isArray(parameterNames)||!Array.isArray(hexValues)){throw new InternalError("Illegal use of requireHexValues")}for(var i=0;i<parameterNames.length;i++){var pName=parameterNames[i];var value=hexValues[i];if(typeof value!="string"||value.length<2||value.length%2!=0||!/^#[0-9A-F]$/i.test(value)){missingFields.push(pName)}}if(missingFields){throw new ApplicationError(description+" missing parameters "+missingFields)}};module.exports.requireFields=function(description,object,fields,defaultsOrValues){var missingFields=[];if(!defaultsOrValues){defaultsOrValues={}}if(!object){throw new InternalError(description+"Object is undefined")}for(var i=0;i<fields.length;i++){var field=fields[i];if(typeof object[field]==undefined){if(typeof defaultsOrValues[i]==undefined){missingFields.push(fields)}else{object[field]=defaultsOrValues[i]}}}if(missingFields.length){throw new InternalError(description+" missing "+missingFields)}};module.exports.requireAndPopulateFieldsFromCookie=function(callDescription,cookie,message){if(!cookie){throw new ApplicationError('Error: "'+callDescription+" is missing the cookie")}if(!cookie.original.id){throw new ApplicationError('Error: "'+callDescription+" is missing the cookie ID")}if(!cookie.original.session_id){throw new ApplicationError('Error: "'+callDescription+" is missing the cookie session ID")}if(!cookie.original.method){throw new ApplicationError('Error: "'+callDescription+" is missing the cookie request")}message[C.kMessageId]=cookie.original.id;message[C.kSessionId]=cookie.original.session_id;message.result=cookie.result};module.exports.populateParams=function(serviceTableObject,params){if(!params){params={}}if(!serviceTableObject){throw new InternalError("populateParams: service object is undefined")}var p;var s;var c;var d;var remainingParts=23132;switch(serviceTableObject.type){case"d":remainingParts=4;d=serviceTableObject;break;case"c":remainingParts=3;c=serviceTableObject;break;case"s":remainingParts=2;s=serviceTableObject;break;case"p":remainingParts=1;p=serviceTableObject;break;default:throw new InternalError('type must be one of: "s", "c" or "d"');break}function storeField(field,obj){remainingParts--;var uuid=obj.uuid;if(!uuid){throw new InternalError('UUID for object of type "'+obj.type+'" is missing')}params[field]=uuid}if(d){storeField(C.kDescriptorUUID,d);c=d.characteristic()}if(c){storeField(C.kCharacteristicUUID,c);s=c.service()}if(s){storeField(C.kServiceUUID,s);p=c.peripheral()}if(p){storeField(C.kPeripheralUUID,p)}if(remainingParts!=0){throw new InternalError("Expected "+remainingParts+" more parts when constructing params of "+serviceTableObject.type)}return params}},{"./../errors":15,"./constants":18}],23:[function(require,module,exports){var ee=require("./event-emitter");var C=require("./constants").C;var ApplicationError=require("./../errors").ApplicationError;var id=1;var hackAlert1Sent=false;var hackAlert2Sent=false;function MessageContext(processor,msg,userContext,timeoutMs){this.msg=msg;this.userContext=userContext;if("undefined"==typeof msg.id){msg.id=Number(id++).toString()}this.id=msg.id;if(!timeoutMs){timeoutMs=C.DEFAULT_MESSAGE_TIMEOUT_MS}var self=this;this.timeout=setTimeout(function(){delete self.timeout;console.warn("Timeout occurred for message",JSON.stringify(msg));processor.emit("error",new ApplicationError("Timed out : "+JSON.stringify(msg)),self.userContext.cb)},timeoutMs)}function MessageProcessor(){ee.instantiateEmitter(this);var self=this;var pendingMessages={};this.register=function(msg,userContext,timeoutMs){if(Object.keys(pendingMessages).length>C.MAX_PENDING_MESSAGES){throw new ApplicationError("Message queue is full",msg)}var entry=new MessageContext(self,msg,userContext,timeoutMs);pendingMessages[entry.id]=entry;return entry.msg};this.hasMessage=function(msgId){var entry=pendingMessages[""+msgId];return!!entry};this.onMessageReceived=function(msg){var entry;if(msg.params&&msg.params.id){console.warn("HACK ALERT: ID is in params!?!");msg.id=msg.params.id}if(msg.id){entry=pendingMessages[""+msg.id]}if(!entry){if(!msg.id){if(msg.result==C.kMessage){if(!hackAlert1Sent){hackAlert1Sent=true;console.warn("HACK ALERT: Hacking the authenticate message")}msg.id="1";entry=pendingMessages["1"]}else{self.emit("indication",msg);return}}else{if(msg.result==C.kScanForPeripherals&&msg.params&&msg.params.bb){if(!hackAlert2Sent){hackAlert2Sent=true;console.warn("HACK ALERT: Scan response has an ID")}self.emit("indication",msg);return}self.emit("request",msg);return}}if(entry.timeout){clearTimeout(entry.timeout)}delete pendingMessages[msg.id];self.emit("response",msg,entry.userContext,entry.msg)}}ee.makeEmitter(MessageProcessor);module.exports.MessageProcessor=MessageProcessor},{"./../errors":15,"./constants":18,"./event-emitter":19}],24:[function(require,module,exports){var C=require("./constants.js").C;var ee=require("./event-emitter");var helper=require("./message-helper");function ServerMessageHandler(gattip,gateway){ee.instantiateEmitter(this);var self=this;this.processMessage=function(message){var obj;if(typeof message==="undefined"||!message){console.warn("Got unknown message from client",mesg.data);return}if(message.error){console.warn("Error in the Request",mesg.error);return}if(message.result&&(message.result==C.kMessage||message.result==C.kAuthenticate)){var authenticated=false;if(!message.error&&typeof message.params=="object"&&message.params[C.kAuthenticate]===true){authenticated=true}self.emit("authenticated",authenticated);return}if(message.method&&message.method==C.kAuthenticate){console.log("Client requested to authenticate with us. Allowing the client");var params={};params[C.kAuthenticate]=true;var response={};response.result=C.kAuthenticate;response.params=params;response[C.kIdField]=message[C.kIdField];response=JSON.stringify(response);self.send(response);return}var cookie={original:message};var p=message.params;function getObject(){var objId=p[C.kObjectId];var retObj;if(typeof objId!="string"){self.sendErrorResponse(cookie,400,"Object ID is required");throw new Error("Object ID is required")}retObj=gateway.getObject(objId);if(typeof retObj!="object"){self.sendErrorResponse(cookie,404,"Object with ID "+objId+" not found");throw new Error("Object with ID "+objId+" not found")}return retObj}function getObjects(type){var peripheralUUID=p[C.kPeripheralUUID];var resultObj={};resultObj.peripheral=gateway.getPeripheral(peripheralUUID);if(resultObj.peripheral&&resultObj.peripheral.uuid){if(type==="p"){return resultObj}var serviceUUID=p[C.kServiceUUID];resultObj.service=resultObj.peripheral.findService(serviceUUID);if(resultObj.service&&resultObj.service.uuid){if(type==="s"){return resultObj}var characteristicUUID=p[C.kCharacteristicUUID];resultObj.characteristic=resultObj.service.findCharacteristic(characteristicUUID);if(resultObj.characteristic&&resultObj.characteristic.uuid){if(type==="c"){return resultObj}var descriptorUUID=p[C.kDescriptorUUID];resultObj.descriptor=resultObj.characteristic.findDescriptor(descriptorUUID);if(resultObj.descriptor&&resultObj.descriptor.uuid){return resultObj}else{self.sendErrorResponse(cookie,404,"Descriptor not found in the service database");throw new Error("Descriptor not found")}}else{self.sendErrorResponse(cookie,404,"Characteristic not found in the service database");throw new Error("Characteristic not found")}}else{self.sendErrorResponse(cookie,404,"Service not found in the service database");throw new Error("Service not found")}}else{self.sendErrorResponse(cookie,404,"Peripheral not found in the service database");throw new Error("Peripheral not found")}}switch(message.method){case C.kConfigure:self.emit("configure",cookie,p[C.kShowPowerAlert],p[C.kIdentifierKey]);break;case C.kScanForPeripherals:self.emit("scan",cookie,p[C.kScanOptionAllowDuplicatesKey],p[C.kServiceUUIDs]);break;case C.kStopScanning:self.emit("stopScan",cookie);break;case C.kCentralState:self.emit("getCentralState",cookie);break;case C.kConnect:try{obj=getObjects("p");self.emit("connect",cookie,obj.peripheral.uuid)}catch(ex){console.error(ex)}break;case C.kDisconnect:try{obj=getObjects("p");self.emit("disconnect",cookie,obj.peripheral.uuid)}catch(ex){console.error(ex)}break;case C.kGetCharacteristicValue:try{obj=getObjects("c",cookie);self.emit("readCharacteristic",cookie,obj.peripheral.uuid,obj.service.uuid,obj.characteristic.uuid)}catch(ex){console.error(ex)}break;case C.kWriteCharacteristicValue:try{obj=getObjects("c",cookie);self.emit("writeCharacteristic",cookie,obj.peripheral.uuid,obj.service.uuid,obj.characteristic.uuid,p[C.kValue])}catch(ex){console.error(ex)}break;case C.kSetValueNotification:try{obj=getObjects("c",cookie);self.emit("enableNotifications",cookie,obj.peripheral.uuid,obj.service.uuid,obj.characteristic.uuid,p[C.kIsNotifying])}catch(ex){console.error(ex)}break;case C.kGetDescriptorValue:try{obj=getObjects("d",cookie);self.emit("readDescriptor",cookie,obj.peripheral.uuid,obj.service.uuid,obj.characteristic.uuid,obj.descriptor.uuid)}catch(ex){console.error(ex)}break;case C.kWriteDescriptorValue:try{obj=getObjects("d",cookie);self.emit("writeDescriptor",cookie,obj.peripheral.uuid,obj.service.uuid,obj.characteristic.uuid,obj.descriptor.uuid,message.params[C.kValue])}catch(ex){console.error(ex)}break;case C.kOpenStream:try{self.emit("openStream",cookie,p[C.kObjectId],{speed:p[C.kSpeed],force:p[C.kForce]})}catch(ex){console.error(ex)}break;case C.kCloseStream:try{obj=getObject();self.emit("closeStream",cookie,obj)}catch(ex){console.error(ex)}break;case C.kWriteStreamData:try{obj=getObject();self.emit("writeStreamData",cookie,obj,p[C.kVal])}catch(ex){console.error(ex)}break;default:console.log("invalid request: "+message.method);self.sendErrorResponse(cookie,C.kInvalidRequest,"Request not handled by server");return}};self.sendErrorResponse=function(cookie,errorId,errMessage){var mesg={},error={};error[C.kCode]=errorId;error[C.kMessageField]=errMessage;mesg[C.kError]=error;if(cookie&&cookie.original){mesg.result=cookie.original.method;mesg[C.kMessageId]=cookie.original.id;mesg[C.kSessionId]=cookie.original.session_id}gattip.sendError(mesg)};self.configureResponse=function(cookie){cookie.result=C.kConfigure;gattip.respond(cookie,{})};self.centralStateResponse=function(cookie,state){var params={};params[C.kState]=state;cookie.result=C.kCentralState;gattip.respond(cookie,params)};self.stopScanResponse=function(cookie){cookie.result=C.kStopScanning;gattip.respond(cookie,{})};self.disconnectResponse=function(cookie,peripheral){var params={};params[C.kPeripheralUUID]=peripheral.uuid;params[C.kPeripheralName]=peripheral.name;cookie.result=C.kDisconnect;gattip.respond(cookie,params)};self.disconnectIndication=function(peripheral){var params={};params[C.kPeripheralUUID]=peripheral.uuid;params[C.kPeripheralName]=peripheral.name;gattip.sendIndications(C.kDisconnect,params)};self.scanResponse=function(cookie){cookie.result=C.kScanForPeripherals;gattip.respond(cookie,{})};self.scanIndication=function(uuid,name,rssi,txPwr,serviceUUIDs,mfrData,svcData,isConnectable){var params={};var manufactData;var serviceData;if(!helper.isEmpty(mfrData)){manufactData={};for(var mk in mfrData){var mkey=mk.toUpperCase();manufactData[mkey]=helper.arrayAsHex(mfrData[mk]).toUpperCase()}}if(!helper.isEmpty(svcData)){serviceData={};for(var sk in svcData){var skey=sk.toUpperCase();serviceData[skey]=helper.arrayAsHex(svcData[sk]).toUpperCase()}}params[C.kPeripheralName]=name;params[C.kPeripheralUUID]=uuid;params[C.kRSSIkey]=rssi;params[C.kCBAdvertisementDataTxPowerLevel]=txPwr;params[C.kCBAdvertisementDataIsConnectable]=isConnectable;params[C.kCBAdvertisementDataServiceUUIDsKey]=serviceUUIDs&&serviceUUIDs.length>0?serviceUUIDs:undefined;params[C.kCBAdvertisementDataManufacturerDataKey]=manufactData;params[C.kCBAdvertisementDataServiceDataKey]=serviceData;gattip.sendIndications(C.kScanForPeripherals,params)};self.openStreamResponse=function(cookie,streamObjectId){var params={};params[C.kObjectId]=streamObjectId;cookie.result=C.kOpenStream;gattip.respond(cookie,params)};self.closeStreamResponse=function(cookie,streamObjectId){var params={};params[C.kObjectId]=streamObjectId;cookie.result=C.kCloseStream;gattip.respond(cookie,params)}}this.GATM_SECURITY_PROPERTIES_NO_SECURITY=0;this.GATM_SECURITY_PROPERTIES_UNAUTHENTICATED_ENCRYPTION_WRITE=1;this.GATM_SECURITY_PROPERTIES_AUTHENTICATED_ENCRYPTION_WRITE=2;this.GATM_SECURITY_PROPERTIES_UNAUTHENTICATED_ENCRYPTION_READ=4;this.GATM_SECURITY_PROPERTIES_AUTHENTICATED_ENCRYPTION_READ=8;this.GATM_SECURITY_PROPERTIES_UNAUTHENTICATED_SIGNED_WRITES=16;this.GATM_SECURITY_PROPERTIES_AUTHENTICATED_SIGNED_WRITES=32;this.GATM_CHARACTERISTIC_PROPERTIES_BROADCAST=1;this.GATM_CHARACTERISTIC_PROPERTIES_READ=2;this.GATM_CHARACTERISTIC_PROPERTIES_WRITE_WO_RESP=4;this.GATM_CHARACTERISTIC_PROPERTIES_WRITE=8;this.GATM_CHARACTERISTIC_PROPERTIES_NOTIFY=16;this.GATM_CHARACTERISTIC_PROPERTIES_INDICATE=32;this.GATM_CHARACTERISTIC_PROPERTIES_AUTHENTICATED_SIGNED_WRITES=64;this.GATM_CHARACTERISTIC_PROPERTIES_EXT_PROPERTIES=128;this.GATM_DESCRIPTOR_PROPERTIES_READ=1;this.GATM_DESCRIPTOR_PROPERTIES_WRITE=2;ee.makeEmitter(ServerMessageHandler);module.exports.ServerMessageHandler=ServerMessageHandler},{"./constants.js":18,"./event-emitter":19,"./message-helper":22}],25:[function(require,module,exports){var C=require("./constants").C;var Service=require("./../service").Service;var Characteristic=require("./../characteristic").Characteristic;var Descriptor=require("./../descriptor").Descriptor;function parseDescriptorFromScanResponse(characteristic,params){var duuid=params[C.kDescriptorUUID];var descriptor=characteristic.findDescriptor(duuid);if(!descriptor){descriptor=new Descriptor(characteristic,duuid);characteristic.addDescriptor(descriptor)}descriptor.value=params[C.kValue]}function parseCharacteristicFromScanResponse(service,params){var cuuid=params[C.kCharacteristicUUID];var characteristic=service.findCharacteristic(cuuid);if(!characteristic){characteristic=new Characteristic(service,cuuid);service.addCharacteristic(characteristic)}characteristic.value=params[C.kValue];var cprops=params[C.kProperties];if(typeof cprops==="object"){for(var flag in cprops){characteristic.setProperty(flag,{enabled:cprops[flag].enabled,name:cprops[flag].name})}}else{for(var apindex in C.AllProperties){characteristic.setProperty([C.AllProperties[apindex]],{enabled:cprops>>apindex&1,name:C.AllProperties[apindex]})}}characteristic.isNotifying=false;var descriptors=params[C.kDescriptors];if(descriptors){for(var didx in descriptors){var dparams=descriptors[didx];parseDescriptorFromScanResponse(characteristic,dparams)}}}function parseServiceFromScanResponse(peripheral,params){var suuid=params[C.kServiceUUID];var service=peripheral.findService(suuid);if(!service){service=new Service(peripheral,suuid);peripheral.addService(service)}var characteristics=params[C.kCharacteristics];if(characteristics){for(var cidx in characteristics){var cparams=characteristics[cidx];parseCharacteristicFromScanResponse(service,cparams)}}}module.exports.parseServiceRecord=function(peripheral,params){var services=params[C.kServices];if(services){for(var sidx in services){var sparams=services[sidx];parseServiceFromScanResponse(peripheral,sparams)}}};function getDescriptorJsonFromCharacteristicObject(myCharacteristic){var descriptor_db={};if(myCharacteristic&&myCharacteristic.getAllDescriptors()){for(var uuid in myCharacteristic.getAllDescriptors()){var temp_descriptor={};temp_descriptor[C.kDescriptorUUID]=uuid;temp_descriptor[C.kValue]=myCharacteristic.findDescriptor(uuid).value;temp_descriptor[C.kProperties]=myCharacteristic.findDescriptor(uuid).properties;temp_descriptor[C.kIsNotifying]=myCharacteristic.findDescriptor(uuid).isNotifying;descriptor_db[uuid]=temp_descriptor}}return descriptor_db}function getCharacteristicJsonFromServiceObject(myService){var characteristic_db={};if(myService&&myService.getAllCharacteristics()){for(var uuid in myService.getAllCharacteristics()){var temp_characteristic={};temp_characteristic[C.kCharacteristicUUID]=uuid;temp_characteristic[C.kValue]=myService.findCharacteristic(uuid).value;temp_characteristic[C.kProperties]=myService.findCharacteristic(uuid).allProperties();temp_characteristic[C.kIsNotifying]=myService.findCharacteristic(uuid).isNotifying;temp_characteristic[C.kDescriptors]=getDescriptorJsonFromCharacteristicObject(myService.findCharacteristic(uuid));characteristic_db[uuid]=temp_characteristic}}return characteristic_db}module.exports.getServiceJsonFromPeripheralObject=function(myPeripheral){var service_db={};if(myPeripheral&&myPeripheral.getAllServices()){for(var uuid in myPeripheral.getAllServices()){var temp_service={};temp_service[C.kServiceUUID]=uuid;temp_service[C.kIsPrimaryKey]=myPeripheral.findService(uuid).isPrimary;temp_service[C.kCharacteristics]=getCharacteristicJsonFromServiceObject(myPeripheral.findService(uuid));service_db[uuid]=temp_service}}return service_db}},{"./../characteristic":13,"./../descriptor":14,"./../service":27,"./constants":18}],26:[function(require,module,exports){var C=require("./lib/constants.js").C;var helper=require("./lib/message-helper");var advDataParser=require("./lib/message-advdata-parser");var ee=require("./lib/event-emitter");var serviceTable=require("./lib/service-table");var Service=require("./service").Service;function pushUnique(array,item){if(array.indexOf(item)==-1){array.push(item);return true}return false}function Peripheral(gattip,uuid,name,rssi,txPwr,connectable,serviceUuids,mfrData,svcData){ee.instantiateEmitter(this);var self=this;this.type="p";this.uuid=uuid;this.isConnected=false;var services={};var manufacturerData={};var serviceData={};var serviceUUIDs=[];this._updateFromScanData=function(name,rssi,txPwr,connectable,serviceUuids,mfrData,svcData,addata,scanData){this.name=name;this.rssi=rssi;this.txPowerLevel=txPwr;this.connectable=connectable;var advertisementData=addata;var scanData=scanData;if(mfrData){for(var mfrId in mfrData){var id=mfrId.toUpperCase();manufacturerData[id]=mfrData[mfrId].toUpperCase()}}if(svcData){for(var serUUID in svcData){serviceData[serUUID]=svcData[serUUID]}}if(serviceUuids){for(var sidx=0;sidx<serviceUuids.length;sidx++){pushUnique(serviceUUIDs,serviceUuids[sidx])}}if(addata){advDataParser.parseAdvArray(self,addata.c2);if(self.advdata.connectable){self.connectable=self.advdata.connectable==="true"}if(self.advdata.txPowerLevel){this.txPowerLevel=self.advdata.txPowerLevel}if(self.advdata.manufacturerData&&!helper.isEmpty(self.advdata.manufacturerData)){for(var mfrKey in self.advdata.manufacturerData){var mKey=mfrKey.toUpperCase();manufacturerData[mKey]=self.advdata.manufacturerData[mfrKey].toUpperCase()}}if(self.advdata.serviceUUIDs&&self.advdata.serviceUUIDs.length>0){pushUnique(serviceUUIDs,self.advdata.serviceUUIDs)}}};this.findService=function(uuid){return services[uuid]};this.getMfrData=function(mfrId){return manufacturerData[mfrId]};this.getSvcData=function(svcId){return serviceData[svcId]};this.hasAdvertisedServiceUUID=function(serviceUUID){return serviceUUIDs.indexOf(serviceUUID)>=0};this.getAllServices=function(){return services};this.getAllMfrData=function(){return manufacturerData};this.getAllSvcData=function(){return serviceData};this.getAllAdvertisedServiceUUIDs=function(){return serviceUUIDs};this.addServiceWithUUID=function(serviceUUID){var service=new Service(self,serviceUUID);return services[serviceUUID]=service};this.addService=function(service){return services[service.uuid]=service};this.gattip=function(){return gattip};this.connectOnce=function(callback){var params=helper.populateParams(self);gattip.request(C.kConnect,params,callback,function(params){serviceTable.parseServiceRecord(self,params);self.isConnected=true;gattip.fulfill(callback,self)})};this.connect=function(callback,config){var fullfillCb=typeof callback=="object"?callback.fulfill:callback;var tries=C.NUM_CONNECT_ATTEMPTS;if(config&&typeof config.numConnectAttempts=="number"){tries=config.numConnectAttempts}function tryConnect(error){if(error){console.log("Failed to connect. Error was",error,"Attempting",tries,"more times")}tries--;if(tries>=0){self.connectOnce({fulfill:fullfillCb,reject:tryConnect})}else{gattip.reject(callback,error)}}tryConnect()};this.disconnect=function(callback){var params=helper.populateParams(self);gattip.request(C.kDisconnect,params,callback,function(params){self.isConnected=false;gattip.fulfill(callback,self)})};this.respondToConnectRequest=function(cookie){var peripheral_db={};peripheral_db[C.kPeripheralUUID]=this.uuid;peripheral_db[C.kPeripheralName]=this.name;var service_db;service_db=serviceTable.getServiceJsonFromPeripheralObject(this);peripheral_db[C.kServices]=service_db;cookie.result=C.kConnect;gattip.respond(cookie,peripheral_db)};this.handleDisconnectIndication=function(){self.isConnected=false;self.emit("disconnected",self)};this._updateFromScanData(name,rssi,txPwr,connectable,serviceUuids,mfrData,svcData)}ee.makeEmitter(Peripheral);module.exports.Peripheral=Peripheral},{"./lib/constants.js":18,"./lib/event-emitter":19,"./lib/message-advdata-parser":20,"./lib/message-helper":22,"./lib/service-table":25,"./service":27}],27:[function(require,module,exports){var helper=require("./lib/message-helper");var Characteristic=require("./characteristic").Characteristic;function Service(peripheral,uuid){var self=this;var gattip=peripheral.gattip();var characteristics={};helper.requireUUID("Service","uuid",uuid);this.uuid=uuid;this.type="s";this.isPrimary=true;this.peripheral=function(){return peripheral};this.gattip=function(){return gattip};this.getAllCharacteristics=function(){return characteristics};this.findCharacteristic=function(uuid){return characteristics[uuid]};this.addCharacteristicWithUUID=function(characteristicUUID,properties){var characteristic=new Characteristic(self,characteristicUUID,properties);return characteristics[characteristicUUID]=characteristic};this.addCharacteristic=function(characteristic){characteristics[characteristic.uuid]=characteristic}}exports.Service=Service},{"./characteristic":13,"./lib/message-helper":22}],28:[function(require,module,exports){var C=require("./lib/constants.js").C;var helper=require("./lib/message-helper");var advDataParser=require("./lib/message-advdata-parser");var ee=require("./lib/event-emitter");var serviceTable=require("./lib/service-table");var Service=require("./service").Service;function Stream(gattip,objectId){ee.instantiateEmitter(this);var self=this;this._objectId=objectId;this.getObjectId=function(){return self._objectId};this.writeData=function(callback,data){helper.requireHexValue("writeData","data",data);var params={};params[C.kObjectId]=self._objectId;params[C.kVal]=data;gattip.request(C.kWriteStreamData,params,callback,function(params){gattip.fulfill(callback,self)})};this.closeStream=function(callback){var params={};params[C.kObjectId]=self._objectId;gattip.request(C.kCloseStream,params,callback,function(params){gattip.fulfill(callback,self)})};this.handleDataIndication=function(params){self.emit("streamData",self,params[C.kValue])};this.handleClosedIndication=function(params){self.emit("streamClosed",self)};this.indicateStreamData=function(data){helper.requireHexValue("indicateStreamData","data",data);var params={};params[C.kObjectId]=self._objectId;params[C.kVal]=data;gattip.sendIndications(C.kStreamDataIndication,params)};this.writeDataResponse=function(cookie){var params={};params[C.kObjectId]=self._objectId;cookie.result=C.kWriteStreamData;gattip.respond(cookie,params)};this.closeStreamResponse=function(cookie){var params={};params[C.kObjectId]=self._objectId;cookie.result=C.kCloseStream;gattip.respond(cookie,params)}}ee.makeEmitter(Stream);module.exports.Stream=Stream},{"./lib/constants.js":18,"./lib/event-emitter":19,"./lib/message-advdata-parser":20,"./lib/message-helper":22,"./lib/service-table":25,"./service":27}],29:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}(function(){try{if(typeof setTimeout==="function"){cachedSetTimeout=setTimeout}else{cachedSetTimeout=defaultSetTimout}}catch(e){cachedSetTimeout=defaultSetTimout}try{if(typeof clearTimeout==="function"){cachedClearTimeout=clearTimeout}else{cachedClearTimeout=defaultClearTimeout}}catch(e){cachedClearTimeout=defaultClearTimeout}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[]};process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],30:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],31:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.readUInt8==="function"}},{}],32:[function(require,module,exports){(function(process,global){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg!==null}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;exports.isBuffer=require("./support/isBuffer");function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=require("inherits");exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./support/isBuffer":31,_process:29,inherits:30}],"gatt-ip":[function(require,module,exports){module.exports.GATTIP=require("./gattip").GATTIP;module.exports.C=require("./lib/constants").C},{"./gattip":17,"./lib/constants":18}]},{},[1]);
